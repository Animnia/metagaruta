name: Deploy Fullstack App

on:
  push:
    branches:
      - main # è§¦å‘åˆ†æ”¯

jobs:
  # ========================================
  # ä»»åŠ¡ 1ï¼šç¼–è¯‘å¹¶éƒ¨ç½²å‰ç«¯ (Vue)
  # ========================================
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: è·å–æœ€æ–°ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: å®‰è£…ä¾èµ–å¹¶æ‰“åŒ…
        working-directory: ./frontend  # ğŸ”‘ å…³é”®ï¼šå‘Šè¯‰ GitHub è¿›å…¥ frontend ç›®å½•æ‰§è¡Œå‘½ä»¤
        run: |
          npm install
          npm run build

      - name: éƒ¨ç½²å‰ç«¯åˆ° Nginx
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "frontend/dist/"    
          target: "/var/www/html/metagaruta_dist/"
          strip_components: 2         

  # ========================================
  # ä»»åŠ¡ 2ï¼šç¼–è¯‘å¹¶éƒ¨ç½²åç«¯ (Go)
  # ========================================
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: è·å–æœ€æ–°ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.7'

      - name: ç¼–è¯‘ Go é’ˆå¯¹ Linux çš„äºŒè¿›åˆ¶æ–‡ä»¶
        working-directory: ./backend  # ğŸ”‘ å…³é”®ï¼šè¿›å…¥ backend ç›®å½•
        env:
          GOOS: linux
          GOARCH: amd64
        run: |
          go mod tidy
          go build -o server main.go

      - name: ä¸Šä¼ åç«¯æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "backend/server"
          target: "/tmp"
          strip_components: 1         

      - name: æ›¿æ¢åç«¯æ–‡ä»¶å¹¶é‡å¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # é‡åˆ°é”™è¯¯å°±åœæ­¢æ‰§è¡Œ
            set -e  

            # åœæ­¢æœåŠ¡
            sudo systemctl stop metagaruta
            
            # æŠŠæ–°ç¼–è¯‘çš„æ–‡ä»¶è¦†ç›–è¿‡å» (æ³¨æ„æ›¿æ¢ your_username)
            # è¿™é‡Œçš„è·¯å¾„å–å†³äºä½ ä¹‹å‰åœ¨æœåŠ¡å™¨ä¸ŠæŠŠ Go ä»£ç æ”¾åœ¨å“ªäº†
            sudo mv /tmp/server /home/${{ secrets.SERVER_USER }}/metagaruta/backend/server
            
            # ç»™æ‰§è¡Œæƒé™
            sudo chmod +x /home/${{ secrets.SERVER_USER }}/metagaruta/backend/server
            
            # é‡å¯æœåŠ¡
            sudo systemctl start metagaruta